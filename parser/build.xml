<?xml version="1.0"?>

<!-- Build file for use with Ant (http://jakarta.apache.org/ant). -->
<project name="grammar-parser-javacc" default="all" basedir=".">

  <description>
This buildfile is used to build the XPath family of grammar descriptions,
specifications, and parser tests.

Properties (first value given is the default):
--------------------------------------
Property name: debug
Property values: false|true
Description: Turns debugging trace on for the parsers.
--------------------------------------

You can set a property from the command line via -Dpropname=propvalue.

Keep in mind that you can use multiple targets.
Example:  build jars test
</description>

  <!-- ===================================================================== -->

  <!--
    These are variables that you might have reasonable cause
    to set differently from the command-line.
    E.g., ant -Ddebug=true
  -->

  <!-- Turns debugging trace on for the parsers. -->
  <property name="debug" value="false"/>

  <!-- This is passed to javacc's -JAVA_UNICODE_ESCAPE arg. -->
  <property name="unicodeinput" value="true"/>

  <!-- 
       legitimate values for $dump are:
         -dumptree
	 -dumpxml
	 -xqueryx

       empty is not a legitimate value
  -->
  <property name="dump" value="-dumptree"/>

  <!-- This is the directory where the by-products of the build go. -->
  <property name="build-dir" value="build"/>

  <!-- This is the directory where the various parsing applets will be assembled. -->
  <property name="applets-dir" value="applets"/>

  <!-- This is the directory where the XQuery Test Suite v1 lives. -->
  <property name="xqts-dir" value="/PATH_TO_LOCAL_COPY_OF_XQTS"/>

  <!-- This is the directory where the XQuery Update Test Suite lives. -->
  <property name="xquts-dir" value="/PATH_TO_LOCAL_COPY_OF_XQUTS"/>

  <!-- This is the directory where the XQuery/XPath Full Text Test Suite lives. -->
  <property name="xqftts-dir" value="/PATH_TO_LOCAL_COPY_OF_XQFTTS"/>

  <!-- This is the directory where the QT3 Test Suite lives. -->
  <property name="qt3ts-dir" value="/PATH_TO_LOCAL_COPY_OF_QT3TS"/>

  <!--
    Note re test suite directory properties:

    Assuming you have a local working copy of a test suite,
    this file can't make a reasonable guess at its relative location,
    because the test suite and this file belong to different CVS repositories.
    So, for the xq*ts-dir properties above, we don't even try.  (Instead,
    we use values that will stick out if they haven't been overriden.)

    You could simply change the above values to whatever is appropriate
    for your local setup. However, then there'd be the danger of accidentally
    committing those settings at some point. You could pass in the correct
    setting on the command-line, e.g.:
        ant -Dxqts-dir=/foo/bar/xquery-test-suite test-xquery-test-suite-v1
    but that would be a pain. So instead, I recommend that you set the
    xq*ts-dir properties via the ANT_ARGS environment variable. E.g.:
        ANT_ARGS="$ANT_ARGS -Dxqts-dir=/foo/bar/xquery-test-suite"
        ANT_ARGS="$ANT_ARGS -Dxqftts-dir=/baz/qux/xpath-full-text-10-test-suite"
    You could put those commands in your shell inititialization, or you could
    put them in ~/.antrc, which is sourced as part of ant's initialization.
  -->

  <!-- ===================================================================== -->

  <!--
    Each of these properties identifies a pre-existing file/dir
    outside this directory. It's unlikely you'd want to set them
    differently from the command-line.
  -->

  <property name="grammar-file"              value="../xpath-grammar.xml"/>
  <property name="fulltext-spec-file"        value="../../xpath-full-text-10/src/xpath-full-text.xml"/>
  <property name="fulltext-uc-file"          value="../../../use-cases/xpath-full-text-10/src/xpath-full-text-use-cases.xml"/>
  <property name="scripting-uc-file"         value="../../../use-cases/xquery-sx-10/src/xquery-sx-use-cases.xml"/>
  <property name="xquery-spec-file"          value="../../xquery-30/src/xquery.xml"/>
  <property name="xquery-uc-file"            value="../../../use-cases/xquery-30/src/xquery-use-cases.xml"/>
  <property name="xquery-regression-tests"   value="../tests/use-cases.xquery"/>
  <property name="update-regression-tests"   value="../tests/update.xquery"/>
  <property name="pathx1-tests"              value="../tests/pathx1-tests.xml"/>
  <!--
  <property name="javacchome"                value="../lib"/>
  -->

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <defaultexcludes add="**/.*.sw?"/> <!-- vim temp files -->

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <!--
    Each target in this section deals with multiple languages.
  -->

  <target name="clean">
    <delete dir="${build-dir}"/>
    <delete><fileset dir="${applets-dir}" excludes="CVS"/></delete>
    <delete file="xpath_ex_from_sp.xml"/>
    <delete file="xquery_ex_from_uc.xquery"/>
    <delete file="xquery_ex_from_sp.xquery"/>
    <delete file="xquery_ex_from_ftsp.xquery"/>
    <delete file="xquery_ex_from_ftsp_simple.xquery"/>
    <delete file="fulltext_ex_from_sp.xquery"/>
    <delete file="fulltext_ex_from_uc.xquery"/>
  </target>


  <target name="validate">
    <xmlvalidate file="${grammar-file}" failonerror="yes" lenient="no" warn="yes"/>
  </target>


  <target name="applets" description="Build applets directory"
          depends="
	    xslt2-patterns.applet,
            xpath1.applet,
            xpath20.applet,
            xpath30.applet,
            xquery10.applet,
            xquery30.applet,
            xquery10-fulltext.applet,
            xquery30-fulltext.applet,
            xquery10-update.applet,
            xquery30-update.applet,
            xquery30-update-scripting.applet,
            xquery10-fulltext-update.applet,
            xquery30-fulltext-update.applet,
            xquery-core.applet
    ">
    <copy todir="${applets-dir}" file="${grammar-file}"/>
    <copy todir="${applets-dir}" file="../grammar.dtd"/>
    <antcall target="xgrammar_zips"/>
  </target>


  <target name="test" description="Runs all quick tests on all grammars."
    depends="
      xslt2-patterns.tests,
      xpath1.tests,
      xpath20.tests,
      xpath30.tests,
      xquery10.tests,
      xquery30.tests,
      xquery10-update.tests,
      xquery30-update.tests,
      xquery30-update-scripting.tests,
      xquery10-fulltext.tests,
      xquery30-fulltext.tests,
      xquery-core.tests
    ">
    <!-- xpath1.tests -->
  </target>

  <target name="long-tests" description="Runs all long tests on all parsers.">
    <antcall.xpath20 target="test-xquery-test-suite-v1"/>
    <antcall.xpath30 target="test-xquery-test-suite-v1"/>

    <antcall.xquery10 target="test-xquery-test-suite-v1"/>
    <antcall.xquery30 target="test-xquery-test-suite-v1"/>

    <antcall.xquery10-update target="test-update-test-suite"/>
    <antcall.xquery30-update target="test-update-test-suite"/>

    <antcall.xquery10-fulltext target="test-fulltext-test-suite"/>
    <antcall.xquery30-fulltext target="test-fulltext-test-suite"/>

    <antcall.xpath20 target="test-xquery-test-suite-v3"/>
    <antcall.xpath30 target="test-xquery-test-suite-v3"/>
    <antcall.xquery10 target="test-xquery-test-suite-v3"/>
    <antcall.xquery30 target="test-xquery-test-suite-v3"/>
  </target>


  <!--============= Build everything important ===============-->
  <target name="all" depends="clean, applets, test"
    description="Build all jars and grammar BNFs.">
  </target>

  <target name="xgrammar_zips">

    <copy todir="xgrammar/grammar" includeEmptyDirs="false">
      <fileset dir=".." >
        <include name="*"/>
        <include name="extractors/*"/>
        <include name="tests/*"/>
        <include name="parser/*"/>
      </fileset>
    </copy>

    <copy todir="xgrammar/lib" includeEmptyDirs="false">
      <fileset dir="../lib" > 
        <include name="*"/>
      </fileset>
    </copy>

    <zip zipfile="${applets-dir}/xgrammar_libs.zip">
      <fileset dir="." includes="xgrammar/lib/**"/>
    </zip>

    <zip zipfile="${applets-dir}/xgrammar_src.zip">
      <fileset dir="." includes="xgrammar/grammar/**"/>
    </zip>

    <delete dir="xgrammar"/>

  </target>

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <!--
    Each of the targets in this section deals with a single fixed language.
    Almost all of them are simply an antcall to a generic target
    that effectively takes a language as a parameter.
  -->

  <!-- =========================================================== -->
  <!-- Targets that deal with XSLT 2.0 Patterns -->

  <target name="xslt2-patterns.applet">
    <antcall.xslt2-patterns target="applet"/>
  </target>

  <target name="xslt2-patterns.tests">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${applets-dir}/xslt2-patterns/applet.jar"/>
      </classpath>
      <arg value="-dumptree"/>
      <arg value="-expr"/> <arg value='para'/>
      <arg value="-expr"/> <arg value='*'/>
      <arg value="-expr"/> <arg value='chapter|appendix'/>
      <arg value="-expr"/> <arg value='olist/entry'/>
      <arg value="-expr"/> <arg value='appendix//para'/>
      <arg value="-expr"/> <arg value='schema-element(us:address)'/>
      <arg value="-expr"/> <arg value='attribute(*, xs:date)'/>
      <arg value="-expr"/> <arg value='/'/>
      <arg value="-expr"/> <arg value='document-node()'/>
      <arg value="-expr"/> <arg value='document-node(schema-element(my:invoice))'/>
      <arg value="-expr"/> <arg value='text()'/>
      <arg value="-expr"/> <arg value='node()'/>
      <arg value="-expr"/> <arg value='id("W33")'/>
      <arg value="-expr"/> <arg value='para[1]'/>
      <arg value="-expr"/> <arg value='//para'/>
      <arg value="-expr"/> <arg value='bullet[position() mod 2 = 0]'/>
      <arg value="-expr"/> <arg value='div[@class="appendix"]//p'/>
      <arg value="-expr"/> <arg value='@class'/>
      <arg value="-expr"/> <arg value='@*'/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XPath 1.0 -->

  <target name="xpath1.jar">
    <antcall.xpath1 target="jar"/>
  </target>

  <target name="xpath1.applet">
    <antcall.xpath1 target="applet"/>
  </target>

  <target name="xpath1.tests" description="Smoke test for XPath1.">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${applets-dir}/xpath1/applet.jar"/>
      </classpath>
      <arg value="-dumptree"/>
      <arg value="-expr"/>
      <arg value="abc"/>
      <arg value="-expr"/>
      <arg value="1+1*3"/>
      <arg value="-expr"/>
      <arg value="1*1+3"/>
      <arg value="-expr"/>
      <arg value="1 &lt; 1 &lt; 2"/>
      <arg value="-expr"/>
      <arg value="1 = 1 = 2"/>
    </java>
    <antcall.xpath1 target="test-against-xpath1-exprs"/>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XPath 2 -->

  <target name="xpath20.jar">
    <antcall.xpath20 target="jar"/>
  </target>

  <target name="xpath20.applet">
    <antcall.xpath20 target="applet"/>
  </target>

  <target name="xpath20.tests">
    <antcall.xpath20 target="test-xpath"/>
  </target>

  <!-- -->

  <target name="xpath30.jar">
    <antcall.xpath30 target="jar"/>
  </target>

  <target name="xpath30-noast.jar">
    <antcall.xpath30 target="jar-noast">
      <param name="jarfilename" value="${applets-dir}/xpath30-noast/applet.jar"/>
    </antcall.xpath30>
  </target>

  <target name="xpath30.jjdoc">
    <antcall.xpath30 target="jjdoc"/>
  </target>

  <target name="xpath30.applet">
    <antcall.xpath30 target="applet"/>
  </target>

  <target name="xpath30.tests">
    <antcall.xpath30 target="test-xpath"/>
  </target>

  <!-- -->

  <target name="test-xpath" description="All quick tests for XPath 2.x"
    depends="
      test-xpath-smoke,
      test-xpath-doc-frags,
      test-against-xpath1-exprs
    ">
  </target>

  <target name="test-xpath-smoke" description="Smoke test for XPath2.    These tests&#10;
          are not compatible with XPath1 and XQuery.">
    <java fork="no" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg value="-dumptree"/>
      <arg value="-expr"/>
      <arg value="abc"/>
      <arg value="-expr"/>
      <arg value="1+1*3"/>
      <arg value="-expr"/>
      <arg value="1*1*(if(***) then if(div div div) then (/) * (/) else /*** else div:div*.)"/>

      <arg value="-expr"/>
      <arg value="\u0058"/>
      <!--
          Bug 13796: the generated lexer recognizes unicode escapes, which it shouldn't.
          (Thus, the expr above should raise an error, but doesn't.)

          This is because we invoke JavaCC with the JAVA_UNICODE_ESCAPE option enabled.
          If we disable it, the expr above raises an error as it should,
          BUT the following valid exprs raise errors that they shouldn't:
      -->
      <arg value="-expr"/>
      <arg value="'(&#226;&#8364;&#176;)'"/>
      <!-- Based on test #573 (line 590) of ../tests/pathx1-tests.xml -->
      <arg value="-expr"/>
      <arg value='"&#60000;"'/>
      <!-- Based on Operators/CompExpr/ValComp/StringComp/StringLT/K2-StringLT-1.xq -->
      <arg value="-expr"/>
      <arg value="'b&#223;&#1682;&#12365;'"/>
      <!-- Based on Functions/AllStringFunc/AssDisassStringFunc/StringToCodepointFunc/fn-string-to-codepoints1args-4.xq -->
    </java>
  </target>

  <target name="test-xpath-doc-frags">
    <xslt style="../extractors/xpath_sp.xsl" in="${xquery-spec-file}"
      out="xpath_ex_from_sp.xml" force="yes" extension=".xml" destdir=".">
      <!-- param name="not-spec" expression="xpath"/ -->
    </xslt>
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="xpath_ex_from_sp.xml"/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery Core -->

  <target name="xquery-core.jar">
    <antcall.xcore target="jar"/>
  </target>

  <target name="xquery-core.jjdoc">
    <antcall.xcore target="jjdoc"/>
  </target>

  <target name="xquery-core.applet-html">
    <antcall.xcore target="gen-applet-html"/>
  </target>

  <target name="xquery-core.applet">
    <antcall.xcore target="applet"/>
  </target>

  <target name="xquery-core.tests">
    <echo message="There are no tests for xquery-core!"/>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery -->

  <target name="xquery10.jar">
    <antcall.xquery10 target="jar"/>
  </target>

  <target name="xquery10.applet">
    <antcall.xquery10 target="applet"/>
  </target>

  <target name="xquery10.tests">
    <antcall.xquery10 target="test-xquery"/>
  </target>

  <!-- -->

  <target name="xquery30.jar">
    <antcall.xquery30 target="jar"/>
  </target>

  <target name="xquery30-nogen.jar">
    <antcall.xquery30 target="jar-nogen"/>
  </target>

  <target name="xquery30.jjdoc">
    <antcall.xquery30 target="jjdoc"/>
  </target>

  <target name="xquery30.applet">
    <antcall.xquery30 target="applet"/>
  </target>

  <target name="xquery30.tests">
    <antcall.xquery30 target="test-xquery"/>
  </target>

  <!-- -->

  <target name="test-xquery" description="All quick tests for XQuery"
    depends="
      test-xquery-smoke,
      test-xquery-xqx-smoke,
      test-xquery-major,
      test-xquery-doc-frags,
      test-xquery-use-cases-doc-frags,
      test-fulltext-semantic-functions
    ">
    <!-- Not test-xquery-test-suite-v1, it takes too long. -->
  </target>

  <target name="test-xquery-smoke"  description="Smoke test for XQuery.    These tests&#10;
          are not compatible with XPath1 and XPath2.">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg value="-dumptree"/>
      <arg value="-expr"/>
      <arg value="if(&lt;abc/>) then $efg else 2 + 2 or false()"/>
    </java>
  </target>

  <target name="test-xquery-xqx-smoke" description="Smoke test for conversion to XQueryX">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}"/>
      </classpath>
      <arg value="-xqueryx"/>
      <arg value="-xqueryxfile"/>
      <arg value="t.xqueryx"/>
      <arg value="-expr"/>
      <arg value="for $i in 0 to $n - 1 return &lt;x i='{$i}'/>"/>

      <arg value="-expr"/>
      <arg value='&lt;e a="b&#10;= {"d e" eq "d&#10;e"}"/&gt;'/>
      <!-- The latter exposes a bug in the converter code. -->
      <!-- That bug is now fixed, but keep the test as a regression-detector. -->

      <arg value="-expr"/>
      <arg value='&lt;e a="b&#xD;&#xA;c{1}"/&gt;'/>
      <!-- Bug: In result, 'b' and 'c' are separated by 2 spaces, should be 1. -->
      <!-- That bug is now fixed, but keep the test as a regression-detector. -->

      <arg value="-expr"/>
      <arg value="
      	xquery version 'O''Malley''s version';
	import schema 'http://name''space' at 'http://schema''location';
	processing-instruction('foo''bar')
      "/>
      <!-- Bug: In result, occurrences of EscapeApos are not converted to '. -->
      <!-- Also, the schema-import hint is mis-handled. -->
      <!-- Those bugs are now fixed, but keep the test as a regression-detector. -->

      <arg value="-expr"/>
      <arg value="&lt;!-- a-&#xD;&#xA;b --&gt;"/>
      <!-- Bug: coming right after a hyphen, the CR doesn't get normalized away. -->

      <arg value="-expr"/>
      <arg value="(# Foo content&#xD;&#xA;if x &lt; 3 &amp; such #){1}"/>
      <!-- Bug: left-angle-bracket and ampersand are not escaped in generated xqx. -->
      <!-- Also, the CR is not elided, though that's hard to see. -->
      <!-- Those bugs are now fixed, but keep the test as a regression-detector. -->
    </java>
  </target>

  <target name="test-xquery-major" description="Smoke test for XQuery expressions. &#10;
          You must specify&#10;
          -Ddump=-dump if you want the jjtree dump&#10;
          (note the dash after the =).">
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg value="${dump}"/> 
      <arg value="${xquery-regression-tests}"/>
    </java>
  </target>

  <target name="test-xquery-doc-frags">
    <xslt style="../extractors/xquery_sp.xsl" in="${xquery-spec-file}"
      out="xquery_ex_from_sp.xquery" force="yes" extension=".xquery" destdir=".">
      <!-- param name="not-spec" expression="xpath"/ -->
    </xslt>
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="xquery_ex_from_sp.xquery"/>
    </java>
  </target>


  <target name="test-xquery-use-cases-doc-frags">
    <xslt style="../extractors/xquery_uc.xsl" in="${xquery-uc-file}"
      out="xquery_ex_from_uc.xquery" force="yes" extension=".xquery" destdir=".">
      <!-- param name="not-spec" expression="xpath"/ -->
    </xslt>
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="xquery_ex_from_uc.xquery"/>
    </java>
  </target>

  <target name="test-xquery-test-suite-v1" description="Major test suite.">
    <echo message="parser language = ${language}"/>
    <java fork="yes" maxmemory="128m" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="../lib/xml-apis.jar" />
        <pathelement path="../lib/xercesImpl.jar" />
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg line="-XQueryXOutputHierarchyRoot _test_suite_v1_xqx/${language}"/>
      <arg value="-catalog1"/>
      <arg value="${xqts-dir}/TestSuiteStagingArea/XQTSCatalog.xml"/>
    </java>
  </target>

  <target name="test-xquery-test-suite-v3" description="Major test suite.">
    <echo message="parser language = ${language}"/>
    <java fork="yes" maxmemory="128m" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="../lib/xml-apis.jar" />
        <pathelement path="../lib/xercesImpl.jar" />
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg line="-XQueryXOutputHierarchyRoot _test_suite_v3_xqx/${language}"/>
      <arg value="-catalog3"/>
      <arg value="${qt3ts-dir}/catalog.xml"/>
    </java>
  </target>

  <target name="test-fulltext-semantic-functions">
    <!--
        Note that although this target involves fragments
	extracted from the Full Text spec, it is not a test of the
	XQuery+Fulltext parser, but rather just the XQuery parser.
	(The fragments are taken from the spec's section 4, which
	defines the semantics of Full Text using "plain" XQuery.)
    -->
    <xslt style="../extractors/fulltext_sp_other.xsl" in="${fulltext-spec-file}"
      out="allmatches.xsd" force="yes" extension=".xquery" destdir=".">
      <param name="targetrole" expression="semfunc-file-allmatches-xsd"/>
    </xslt>

    <xslt style="../extractors/fulltext_sp_other.xsl" in="${fulltext-spec-file}"
      out="ftselection.xsd" force="yes" extension=".xquery" destdir=".">
      <param name="targetrole" expression="semfunc-file-ftselection-xsd"/>
    </xslt>

    <xslt style="../extractors/fulltext_sp_other.xsl" in="${fulltext-spec-file}"
      out="xquery_ex_from_ftsp.xquery" force="yes" extension=".xquery" destdir=".">
      <param name="targetrole" expression="semfunc-file-fts-xquery"/>
    </xslt>

    <!-- test whether we can parse the extracted XQuery functions  -->
    <antcall target="test-fulltext-semantic-functions-do-parse">
      <param name="filetotest" value="xquery_ex_from_ftsp.xquery"/>
    </antcall>

    <xslt style="../extractors/fulltext_sp_other.xsl" in="${fulltext-spec-file}"
      out="xquery_ex_from_ftsp_simple.xquery" force="yes" extension=".xquery" destdir=".">
      <param name="targetrole" expression="semfunc-file-ftssimple-xquery"/>
    </xslt>

    <!-- test whether we can parse the extracted XQuery functions  -->
    <antcall target="test-fulltext-semantic-functions-do-parse">
      <param name="filetotest" value="xquery_ex_from_ftsp_simple.xquery"/>
    </antcall>
  </target>

  <target name="test-fulltext-semantic-functions-do-parse">
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="${filetotest}"/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery + Update Extensions -->

  <target name="xquery10-update.jar">
    <antcall.xquery10-update target="jar"/>
  </target>

  <target name="xquery10-update.applet">
    <antcall.xquery10-update target="applet"/>
  </target>

  <target name="xquery10-update.tests">
    <antcall.xquery10-update target="test-update"/>
  </target>

  <!-- -->

  <target name="xquery30-update.jar">
    <antcall.xquery30-update target="jar"/>
  </target>

  <target name="xquery30-update-noast.jar">
    <antcall.xquery30-update target="jar-noast">
      <param name="jarfilename" value="${applets-dir}/xquery30-update-noast/applet.jar"/>
    </antcall.xquery30-update>
  </target>

  <target name="xquery30-update.jjdoc">
    <antcall.xquery30-update target="jjdoc"/>
  </target>

  <target name="xquery30-update.applet-html">
    <antcall.xquery30-update target="gen-applet-html"/>
  </target>

  <target name="xquery30-update.applet">
    <antcall.xquery30-update target="applet"/>
  </target>

  <target name="xquery30-update.tests">
    <antcall.xquery30-update target="test-update"/>
  </target>

  <!-- -->

  <target name="test-update" description="All quick tests for XQuery Update."
    depends="
      test-update-smoke,
      test-update-xqx-smoke
    ">
    <!-- Not test-update-test-suite, it takes too long. -->
  </target>

  <target name="test-update-smoke" description="Test for XQuery update language.">
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="${update-regression-tests}"/>
    </java>
  </target>

  <target name="test-update-xqx-smoke" description="Smoke test for conversion to XQueryX">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}"/>
      </classpath>
      <arg value="-xqueryx"/>
      <arg value="-xqueryxfile"/>
      <arg value="t.xqueryx"/>
      <arg value="-expr"/>
      <arg value="rename node /a/b as $new-name"/>
    </java>
  </target>

  <target name="test-update-test-suite">
    <echo message="parser language = ${language}"/>
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
      </classpath>
      <arg line="-XQueryXOutputHierarchyRoot _test_suite_v1_xqx/${language}"/>
      <arg value="-catalog1"/>
      <arg value="${xquts-dir}/XQUTSCatalog.xml"/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery + Scripting Extensions -->

  <target name="xquery30-update-scripting.applet">
    <antcall.xquery30-update-scripting target="applet"/>
  </target>

  <target name="xquery30-update-scripting.tests">
    <antcall.xquery30-update-scripting target="test-xquery-update-scripting"/>
  </target>

  <!-- -->

  <target name="test-xquery-update-scripting"
    depends="
      test-scripting-use-cases
    ">
  </target>

  <target name="test-scripting-use-cases">
    <xslt style="../extractors/scripting_uc.xsl" in="${scripting-uc-file}"
      out="scripting_ex_from_uc.xquery" force="yes" extension=".xquery" destdir="."/>
    <java fork="yes" jar="${jarfilename}">
      <assertions><enable/></assertions>
      <arg value="scripting_ex_from_uc.xquery"/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery + Full Text Extensions -->

  <target name="xquery10-fulltext.jar">
    <antcall.xquery10-fulltext target="jar"/>
  </target>

  <target name="xquery10-fulltext.applet">
    <antcall.xquery10-fulltext target="applet"/>
  </target>

  <target name="xquery10-fulltext.tests">
    <antcall.xquery10-fulltext target="test-xquery-fulltext"/>
  </target>

  <!-- -->

  <target name="xquery30-fulltext.jar">
    <antcall.xquery30-fulltext target="jar"/>
  </target>

  <target name="xquery30-fulltext.jjdoc">
    <antcall.xquery30-fulltext target="jjdoc"/>
  </target>

  <target name="xquery30-fulltext.applet-html">
    <antcall.xquery30-fulltext target="gen-applet-html"/>
  </target>

  <target name="xquery30-fulltext.applet">
    <antcall.xquery30-fulltext target="applet"/>
  </target>

  <target name="xquery30-fulltext.tests">
    <antcall.xquery30-fulltext target="test-xquery-fulltext"/>
  </target>

  <!-- -->

  <target name="test-xquery-fulltext" description="All quick tests for XQuery/XPath Full Text"
    depends="
      test-fulltext-xqx-smoke,
      test-fulltext-doc-frags,
      test-fulltext-use-cases-doc-frags
    ">
    <!-- Not test-fulltext-test-suite, it takes too long. -->
  </target>

  <target name="test-fulltext-xqx-smoke" description="Smoke test for conversion to XQueryX">
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}"/>
      </classpath>
      <arg value="-xqueryx"/>
      <arg value="-xqueryxfile"/>
      <arg value="t.xqueryx"/>
      <arg value="-expr"/>
      <arg value="$x contains text 'a' ftand {$y} phrase occurs exactly 2 times using stemming weight {10} distance at least 3 sentences"/>
    </java>
  </target>

  <target name="test-fulltext-use-cases-doc-frags">
    <xslt style="../extractors/fulltext_ucsp.xsl" in="${fulltext-uc-file}"
      out="fulltext_ex_from_uc.xquery" force="yes" extension=".xquery" destdir=".">
      <!-- param name="not-spec" expression="xpath"/ -->
    </xslt>
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="fulltext_ex_from_uc.xquery"/>
    </java>
  </target>

  <target name="test-fulltext-doc-frags">
    <xslt style="../extractors/fulltext_ucsp.xsl" in="${fulltext-spec-file}"
      out="fulltext_ex_from_sp.xquery" force="yes" extension=".xquery" destdir=".">
      <!-- param name="not-spec" expression="xpath"/ -->
    </xslt>
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
      </classpath>
<!--      <arg value="${dump}"/> -->
      <arg value="fulltext_ex_from_sp.xquery"/>
    </java>
  </target>

  <target name="test-fulltext-test-suite">
    <echo message="parser language = ${language}"/>
    <java fork="yes" classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
      </classpath>
      <arg line="-XQueryXOutputHierarchyRoot _test_suite_v1_xqx/${language}"/>
      <arg value="-catalog1"/>
      <arg value="${xqftts-dir}/TestSuiteStagingArea/XQFTTSCatalog.xml"/>
    </java>
  </target>

  <!-- =========================================================== -->
  <!-- Targets that deal with XQuery + Full Text Extensions + Update Extensions -->

  <target name="xquery10-fulltext-update.applet">
    <antcall.xquery10-fulltext-update target="applet"/>
  </target>

  <!-- -->

  <target name="xquery30-fulltext-update.applet">
    <antcall.xquery30-fulltext-update target="applet"/>
  </target>

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <!--
    Here we define several presets based on the <antcall> task,
    one preset for each language that this build file handles.
  -->

  <presetdef name="antcall.xslt2-patterns">
    <antcall inheritAll="false">
      <param name="spec"        value="xslt2-patterns"/>
      <param name="language"    value="xslt2-patterns"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xpath1">
    <antcall inheritAll="false">
      <param name="spec"        value="xpath1"/>
      <param name="language"    value="xpath1"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xpath20">
    <antcall inheritAll="false">
      <param name="spec"        value="xpath20"/>
      <param name="language"    value="xpath20"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xpath30">
    <antcall inheritAll="false">
      <param name="spec"        value="xpath30"/>
      <param name="language"    value="xpath30"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xcore">
    <antcall inheritAll="false">
      <param name="spec"        value="xcore"/>
      <param name="language"    value="xquery-core"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery10">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery10"/>
      <param name="language"    value="xquery10"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery30">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery30"/>
      <param name="language"    value="xquery30"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>
  
  <presetdef name="antcall.xquery10-update">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery10"/>
      <param name="spec2"       value="update"/>
      <param name="language"    value="xquery10-update"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery30-update">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery30"/>
      <param name="spec2"       value="update"/>
      <param name="language"    value="xquery30-update"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery10-fulltext">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery10"/>
      <param name="spec2"       value="fulltext"/>
      <param name="language"    value="xquery10-fulltext"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery30-fulltext">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery30"/>
      <param name="spec2"       value="fulltext"/>
      <param name="language"    value="xquery30-fulltext"/>
      <param name="include-XQueryXConverter" value="yes"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery30-update-scripting">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery30"/>
      <param name="spec2"       value="update"/>
      <param name="spec3"       value="scripting"/>
      <param name="language"    value="xquery30-update-scripting"/>
      <!-- not yet: <param name="include-XQueryXConverter" value="yes"/> -->
      <param name="status"      value="experimental-combo"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery10-fulltext-update">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery10"/>
      <param name="spec2"       value="fulltext"/>
      <param name="spec3"       value="update"/>
      <param name="language"    value="xquery10-fulltext-update"/>
      <param name="include-XQueryXConverter" value="yes"/>
      <param name="status"      value="experimental-combo"/>
    </antcall>
  </presetdef>

  <presetdef name="antcall.xquery30-fulltext-update">
    <antcall inheritAll="false">
      <param name="spec"        value="xquery30"/>
      <param name="spec2"       value="fulltext"/>
      <param name="spec3"       value="update"/>
      <param name="language"    value="xquery30-fulltext-update"/>
      <param name="include-XQueryXConverter" value="yes"/>
      <param name="status"      value="experimental-combo"/>
    </antcall>
  </presetdef>

  <!--
    The following properties normally get their values based on
    the values of parameters specified in the presets above.
  -->

  <!-- Specifies the desired grammar subset for many targets. -->
  <property name="spec"  value="dummy"/>
  <property name="spec2" value="dummy"/>
  <property name="spec3" value="dummy"/>

  <property name="status" value=""/>

  <property name="language-build-dir" value="${build-dir}/${language}"/>

  <property name="java-gen" value="${language-build-dir}/java"/>

  <property name="extracted-grammar" value="${language-build-dir}/grammar.xml"/>
  <property name="jjt"      value="${java-gen}/org/w3c/xqparser/xpath-grammar.jjt"/>
  <property name="jj"       value="${java-gen}/org/w3c/xqparser/xpath-grammar.jj"/>
  <property name="jj-extra" value="${java-gen}/xpath-grammar.jj"/>

  <property name="jjdoc-output" value="${language-build-dir}/jjdoc.html"/>

  <property name="class-root" value="${language-build-dir}/classes"/>

  <property name="jarfilename" value="${applets-dir}/${language}/applet.jar"/>

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <!--
    Each target in this section deals with a single language at a time,
    effectively taking that language as a parameter.

    Normally, they are invoked (directly or indirectly) via one of the
    'antcall' presets defined in the previous section.
  -->

  <!--============= JavaCC Parser Builds ===============-->

  <!--
    How we build the XQuery -> XQueryX converters
    =============================================

    This scheme is predicated on the observation that there's only one
    converter per ${language}, so the name of the XQueryX converter class
    can be the same in every ${language}.  Specifically, the class that
    implements the conversion for the "base language" (XQuery 1.0 or 1.1)
    is always named
        XQueryXConverterBase
    and the class that implements the conversion for the whole language
    (i.e., including an optional extension such as Update or Full Text)
    is always named
        XQueryXConverter
    Of course, different ${language}s want different code to  be in those
    classes, so there's a renaming that takes place during build...
    
        Files
            XQueryXConverterBase-xquery10.java and
            XQueryXConverterBase-xquery30.java
        both declare
            class XQueryXConverterBase
        For the build of any given (XQuery-based) jar/applet,
            XQueryXConverterBase-${spec}.java
        is copied to
            XQueryXConverterBase.java
        in the build directory.
    
        Files
            XQueryXConverter-dummy.java
            XQueryXConverter-update.java and
            XQueryXConverter-fulltext.java
        all declare
            class XQueryXConverter extends XQueryXConverterBase
        which is instantiated by
            XQueryApplet.java and
            Test.java
        When building a given (XQuery-based) jar/applet,
            XQueryXConverter-${spec2}.java
        is copied to
            XQueryXConverter.java
        in the build directory.
    
        The "-dummy" file is for when you're building a jar/applet for
        the unextended base language (i.e., when ${spec2}='dummy').
        Its declaration of
            XQueryXConverter
        doesn't override any of the methods of
            XQueryXConverterBase,
        so it functions the same as XQueryXConverterBase, but under the
        expected name of XQueryXConverter.
    
    Note that this scheme can't handle the case of a base language
    plus two extensions. (If you try, you get two declarations of
    XQueryXConverter in the same jar.) Handling such cases would be
    significantly trickier, I think.
  -->

  <target name="extract-grammar" depends="validate">
    <echo message="spec: ${spec}"/>
    <echo message="spec2: ${spec2}"/>
    <echo message="spec3: ${spec3}"/>
    <xslt style="strip.xsl" in="${grammar-file}"
           out="${extracted-grammar}" force="yes" extension=".jjt" destdir="${java-gen}">
      <param name="spec1" expression="${spec}"/>
      <param name="spec2" expression="${spec2}"/>
      <param name="spec3" expression="${spec3}"/>
    </xslt>
  </target>

  <target name="prep-if-xqx" if="include-XQueryXConverter">
    <xslt
        style="ConversionController.xsl"
        in="${extracted-grammar}"
        out="${java-gen}/org/w3c/xqparser/ConversionController.java">
      <!--
        The stylesheet doesn't actually use ${extracted-grammar},
        but we're obliged to provide a source document.
      -->
      <param name="spec1" expression="${spec}"/>
      <param name="spec2" expression="${spec2}"/>
      <param name="spec3" expression="${spec3}"/>
    </xslt>
    <copy file="XQueryXConverter.java"              todir="${java-gen}/org/w3c/xqparser"/>
    <copy file="XQueryXConverterBase-${spec}.java" tofile="${java-gen}/org/w3c/xqparser/XQueryXConverter_${spec}.java"/>
    <copy file="XQueryXConverter-${spec2}.java"    tofile="${java-gen}/org/w3c/xqparser/XQueryXConverter_${spec2}.java"/>
    <copy file="XQueryXConverter-${spec3}.java"    tofile="${java-gen}/org/w3c/xqparser/XQueryXConverter_${spec3}.java"/>
    <copy file="XQueryApplet.java"                 tofile="${java-gen}/org/w3c/xqparser/XPathApplet.java"/>
    <copy file="XMLWriter.java"                     todir="${java-gen}/org/w3c/xqparser"/>
    <copy file="XMLValidator.java"                  todir="${java-gen}/org/w3c/xqparser"/>
  </target>

  <target name="prep-unless-xqx" unless="include-XQueryXConverter">
    <copy file="XPathApplet.java" tofile="${java-gen}/org/w3c/xqparser/XPathApplet.java"/>
  </target>

  <target name="gen-grammar" depends="extract-grammar, prep-if-xqx, prep-unless-xqx">
    <!-- style="javacc.xsl" -->
    <mkdir dir="${java-gen}/org/w3c/xqparser"/>
    <copy file="SimpleNode.java" todir="${java-gen}/org/w3c/xqparser"/>
    <copy file="Xq2xml.java" todir="${java-gen}/org/w3c/xqparser"/>
    <copy file="PostParseException.java" todir="${java-gen}/org/w3c/xqparser"/>
    <copy file="Test.java" todir="${java-gen}/org/w3c/xqparser">
      <filterset>
        <filter token="language" value="${language}"/>
      </filterset>
    </copy>
    <copy file="ParseBAL.java" todir="${java-gen}/org/w3c/xqparser"/>
    <xslt style="jjtree.xsl" in="${extracted-grammar}"
           out="${jjt}" force="yes" extension=".jjt" destdir="${java-gen}">
      <classpath>
        <pathelement path="../lib/saxon9.jar"/>
      </classpath>
    </xslt>
  </target>

  <target name="gen-grammar-noast" depends="extract-grammar">
    <!-- style="javacc.xsl" -->
    <mkdir dir="${java-gen}/org/w3c/xqparser"/>
    <copy file="PostParseException.java" todir="${java-gen}/org/w3c/xqparser"/>
    <xslt style="noast.xsl" in="${extracted-grammar}"
           out="${jj}" force="yes" extension=".jj" destdir="${java-gen}">
      <classpath>
        <pathelement path="../lib/xalan.jar"/>
      </classpath>
    </xslt>
  </target>

  <target name="jjtree" depends="gen-grammar">
    <!-- jjtree target="${jjt}"
            javacchome="${javacchome}"
            / -->
    <java fork="yes" classname="jjtree">
       <classpath>
         <pathelement path="${java.class.path}/" />
         <pathelement path="../lib/javacc.jar"/>
         <pathelement path="../lib/optional.jar"/>
         <pathelement path="../lib/xalan.jar"/>
         <pathelement path="../lib/xml-apis.jar"/>
       </classpath>
       <arg line="-OUTPUT_DIRECTORY=${java-gen}/org/w3c/xqparser ${jjt}"/>
     </java>
  </target>

  <target name="jjtree-nogen">
    <!-- for debugging when you want to modify the .jjt file directly -->
    <!-- jjtree target="${jjt}" javacchome="${javacchome}" -->
    <java fork="yes" classname="jjtree">
       <classpath>
         <pathelement path="${java.class.path}/" />
         <pathelement path="../lib/javacc.jar"/>
         <pathelement path="../lib/optional.jar"/>
         <pathelement path="../lib/xalan.jar"/>
         <pathelement path="../lib/xml-apis.jar"/>
       </classpath>
       <arg line="-OUTPUT_DIRECTORY=${java-gen} ${jjt}"/>
     </java>
     <!-- generates ${jj-extra} -->
  </target>

  <target name="javacc-noast" depends="gen-grammar-noast">
    <!-- javacc target="${jj}"
            javacchome="${javacchome}"
            debugtokenmanager="${debug}"
            debugparser="${debug}"
            sanitycheck="true"
            javaunicodeescape="${unicodeinput}"
            / -->
    <java fork="yes" classname="javacc">
      <classpath>
        <pathelement path="${java.class.path}/" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
      </classpath>
      <arg line="-OUTPUT_DIRECTORY=${java-gen}/org/w3c/xqparser -DEBUG_LOOKAHEAD=${debug} -DEBUG_TOKEN_MANAGER=${debug} -DEBUG_PARSER=${debug} -JAVA_UNICODE_ESCAPE=${unicodeinput} ${jj}"/>
    </java>
    <mkdir dir="${java-gen}/org/w3c/xqparser"/>
    <move todir="${java-gen}/org/w3c/xqparser">
      <fileset dir="${java-gen}" casesensitive="no">
        <include name="*.java"/>
      </fileset>
    </move>

  </target>

  <target name="javacc" depends="jjtree">
    <!-- javacc target="${jj}"
            javacchome="${javacchome}"
            debugtokenmanager="${debug}"
            debugparser="${debug}"
            sanitycheck="true"
            javaunicodeescape="${unicodeinput}"
            / -->
    <java fork="yes" classname="javacc">
      <classpath>
        <pathelement path="${java.class.path}/" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
      </classpath>
      <arg line="-OUTPUT_DIRECTORY=${java-gen}/org/w3c/xqparser -DEBUG_LOOKAHEAD=${debug} -DEBUG_TOKEN_MANAGER=${debug} -DEBUG_PARSER=${debug} -JAVA_UNICODE_ESCAPE=${unicodeinput} ${jj}"/>
    </java>
    <!-- mkdir dir="${java-gen}/org/w3c/xqparser"/>
    <move todir="${java-gen}/org/w3c/xqparser">
      <fileset dir="${java-gen}/org/w3c/xqparser" casesensitive="no">
        <include name="*.java"/>
      </fileset>
    </move -->

  </target>

  <target name="javacc-nogen" depends="jjtree-nogen">
    <!-- javacc target="${jj-extra}"
            javacchome="${javacchome}"
            debugtokenmanager="${debug}"
            debugparser="${debug}"
            sanitycheck="true"
            javaunicodeescape="${unicodeinput}"
            / -->
    <java fork="yes" classname="javacc">
      <classpath>
        <pathelement path="${java.class.path}/" />
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
      </classpath>
        <arg line="-OUTPUT_DIRECTORY=${java-gen} -DEBUG_LOOKAHEAD=${debug} -DEBUG_TOKEN_MANAGER=${debug} -DEBUG_PARSER=${debug} -JAVA_UNICODE_ESCAPE=${unicodeinput} ${jj-extra}"/>
    </java>

  </target>

  <target name="compile-nogen" depends="javacc-nogen">
    <mkdir dir="${class-root}"/>
    <java_compile srcdir="${java-gen}" destdir="${class-root}"/>
  </target>

  <target name="compile-noast" depends="javacc-noast">
    <mkdir dir="${class-root}"/>
    <java_compile srcdir="${java-gen}" destdir="${class-root}"/>
  </target>

  <target name="compile" depends="javacc">
    <mkdir dir="${class-root}"/>
    <java_compile srcdir="${java-gen}" destdir="${class-root}">
      <classpath>
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
        <pathelement path="${class-root}/" />
      </classpath>
    </java_compile>
  </target>

  <target name="compile-only">
    <mkdir dir="${class-root}"/>
    <java_compile srcdir="${java-gen}" destdir="${class-root}"/>
  </target>

  <!-- Factor out the options that we'll always want to pass to the javac task. -->
  <presetdef name="java_compile">
    <javac source="1.4" target="1.4" debug="true" debuglevel="lines,vars,source" />
  </presetdef>

  <target name="jar-nogen" depends="compile-nogen"
          description="Build one of the grammar parser jars.">
    <jar jarfile="${jarfilename}" manifest="manifest.txt">
      <fileset dir="${class-root}"/>
    </jar>
  </target>

  <target name="jar-noast" depends="compile-noast"
          description="Build one of the grammar parser jars.">
    <jar jarfile="${jarfilename}" manifest="manifest.txt">
      <fileset dir="${class-root}"/>
    </jar>
  </target>

  <target name="jar" depends="compile"
          description="Build one of the grammar parser jars.">
    <jar jarfile="${jarfilename}" manifest="manifest.txt">
      <fileset dir="${class-root}"/>
    </jar>
  </target>

  <!--============= demo applets ===============-->

  <target name="gen-applet-html" description="build html file to hold demo applet.">
    <mkdir dir="${applets-dir}/${language}"/>
    <xslt style="applet.xsl" in="applet.xml"
           out="${applets-dir}/${language}/Overview.html" force="yes" extension=".html" destdir=".">
      <param name="spec"  expression="${spec}"/>
      <param name="spec2" expression="${spec2}"/>
      <param name="spec3" expression="${spec3}"/>
      <param name="status" expression="${status}"/>
    </xslt>
  </target>

  <target name="applet" depends="gen-applet-html, jar, jjdoc"
          description="Build one of the grammar parser jars.">
    <copy file="${jjt}" tofile="${applets-dir}/${language}/grammar.jjt"/>
    <copy file="${jj}"  tofile="${applets-dir}/${language}/grammar.jj"/>
    <copy file="${jjdoc-output}" tofile="${applets-dir}/${language}/jjdoc.html"/>
  </target>


  <!--============= Parser testing ===============-->

  <!-- This won't work right now because of arg size limitations. -->
  <target name="test-against-xpath1-exprs" description="Smoke test for XPath1 expressions.">
    <java fork="yes"  classname="org.w3c.xqparser.Test">
      <assertions><enable/></assertions>
      <classpath>
        <pathelement path="${jarfilename}" />
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg value="-dumptree"/>
      <arg value="${pathx1-tests}"/>
    </java>
  </target>

  <!-- ============= Spec targets =============== -->

  <target name="jjdoc" depends="gen-grammar"
          description="Build a jjdoc-produced BNF.">
    <java fork="yes" classname="org.javacc.jjdoc.JJDocMain">
      <classpath>
        <pathelement path="../lib/javacc.jar"/>
        <pathelement path="../lib/optional.jar"/>
        <pathelement path="../lib/xalan.jar"/>
        <pathelement path="../lib/xml-apis.jar"/>
        <pathelement path="${java.class.path}/" />
      </classpath>
      <arg line="-ONE_TABLE=true -OUTPUT_FILE=${jjdoc-output} ${jj}"/>
    </java>
  </target>

  <!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->

  <target name="AntStructure">
    <antstructure output="build.dtd"/>
  </target>

</project>
