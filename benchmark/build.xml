<?xml version="1.0"?>
<project name="xpath-benchmark" default="all" basedir="."
         xmlns:unless="ant:unless">

  <description>
This buildfile is used to retrieve and parse XPath expressions from various sources.
  </description>
  <target name="all" depends="compile,saxon,sources.xslt,sources.xquery"/>

  <property name="online" value="true"/>

  <!-- path to schemas -->  
  <fileset id="fs.schemas" dir="../xsd" includes="xpath*.xsd"/>
  <pathconvert property="schemas" refid="fs.schemas" pathsep=" "/>
  <fileset id="fs.relaxng" dir="../relaxng" includes="xpath-*.rnc"/>
  <pathconvert property="relaxng" refid="fs.relaxng" pathsep=" "/>

  <!-- path to classes -->
  <path id="classpath">
    <pathelement path="../target/classes"/>
    <pathelement path="../lib/jing.jar"/>
  </path>
  
  <!-- macro for processing benchmark files -->
  <macrodef name="process">
    <attribute name="name"/>
    <attribute name="includes"/>
    <attribute name="arg"/>
    <attribute name="license" default=""/>
    <sequential>
      <local name="tests"/>
      <local name="count.tests"/>
      <fileset id="fs.tests" dir="@{name}" includes="@{includes}"/>
      <pathconvert property="tests" refid="fs.tests" pathsep=" "/>
      <resourcecount property="count.tests" refid="fs.tests"/>
      <echo message="Parsing ${count.tests} files..."/>
      <java fork="yes" classname="fr.lsv.xpparser.Main"
            classpathref="classpath"
            output="@{name}-full.xml" error="@{name}.log">
        <assertions><!-- this is ignored!!! -->
          <enable/>
        </assertions>
        <jvmarg value="-Xmx7000M"/>
        <arg line="@{arg} --unique ${tests} --rnc ${relaxng}"/>
      </java>
      <copy unless:blank="@{license}"
            file="@{name}/@{license}" tofile="@{name}.LICENSE"/>
      <xslt style="../xslt/filter.xsl"
          in="@{name}-full.xml"
          out="@{name}.xml">
        <classpath>
          <pathelement path="../lib/saxon9he.jar"/>
        </classpath>
      </xslt>
    </sequential>
  </macrodef>

  <!-- main macro for benchmarks -->
  <macrodef name="benchmark">
    <attribute name="name"/>
    <attribute name="src"/>
    <attribute name="includes"/>
    <attribute name="arg"/>
    <attribute name="license" default=""/>
    <sequential>
      <local name="offline"/>
      <available file="@{name}" property="offline"/>
      <mkdir unless:set="offline" dir="@{name}"/>
      <get unless:set="offline" src="@{src}"
           dest="@{name}/source.zip" usetimestamp="true"/>
      <unzip unless:set="offline" src="@{name}/source.zip"
             dest="@{name}" overwrite="no"/>
      <process name="@{name}" includes="@{includes}" arg="@{arg}"
               license="@{license}"/>
    </sequential>
  </macrodef>

  <target name="compile" description="Compile xpparser">
    <subant target="compile">
      <fileset dir=".." includes="build.xml"/>
    </subant>
  </target>

  <!-- ===============================================================
       Tests are not representative of actual XPath content `out there'
       but are useful to test our parser.
  -->
  
  <target name="tests" depends="w3c,xpathmark"/>

  <!-- W3C test-suite -->
  <target name="w3c">
    <benchmark name="w3c"
       src="https://dev.w3.org/2011/QT3-test-suite/releases/QT3_1_0.zip"
       includes="QT3_1_0/*/*.xml,QT3_1_0/*/*/*.xml" arg="--xml &quot;//*[local-name() = 'test' and preceding-sibling::*[local-name() = 'dependency' and @type='spec' and starts-with(@value,'XP')] and not(following-sibling::*[local-name() = 'result' and descendant::*[local-name() = 'error']])]&quot;"/>
  </target>

  <!-- XPathMark -->
  <target name="xpathmark">
    <benchmark name="xpathmark"
      src="http://users.dimi.uniud.it/~massimo.franceschet/xpathmark/PT/queries.zip"
      includes="xpath-pt/xslt/*.xsl" arg="--xml '//@select'"/>
  </target>
  
  <!-- PoliticalMashup -->
  <target name="politicalmashup">
      <fileset id="xsl.fs.tests" dir="politicalmashup" includes="*.xsl"/>
      <pathconvert property="xsl.tests" refid="xsl.fs.tests" pathsep=" "/>
      <resourcecount property="xsl.count.tests" refid="xsl.fs.tests"/>
      <echo message="Parsing ${xsl.count.tests} files..."/>
      <java fork="yes" classname="fr.lsv.xpparser.Main"
            classpathref="classpath"
            output="politicalmashup-full-1.xml" error="politicalmashup1.log">
        <assertions><!-- this is ignored!!! -->
          <enable/>
        </assertions>
        <arg line="--xslt --unique ${xsl.tests} --rnc ${relaxng}"/>
      </java>
      <fileset id="xq.fs.tests" dir="politicalmashup" includes="*.xquery"/>
      <pathconvert property="xq.tests" refid="xq.fs.tests" pathsep=" "/>
      <resourcecount property="xq.count.tests" refid="xq.fs.tests"/>
      <echo message="Parsing ${xq.count.tests} files..."/>
      <java fork="yes" classname="fr.lsv.xpparser.Main"
            classpathref="classpath"
            output="politicalmashup-full-2.xml" error="politicalmashup2.log">
        <assertions><!-- this is ignored!!! -->
          <enable/>
        </assertions>
        <arg line="--xquery ../xslt/xqx2xql.xsl --unique ${xq.tests} --rnc ${relaxng}"/>
      </java>
  </target>

  <!-- ===============================================================
       Sources are assumed to provide a good insight into what kind of
       XPath expressions are actually used in practice.
  -->
  
  <target name="sources.xslt" depends="docbook,htmlbook,tei"/>
  <target name="sources.xquery" depends="existdb,marklogic,xqjson,histei,xquerydoc,guidomatic"/>
  
  <!-- DocBook XSL -->
  <target name="docbook">
    <mkdir dir="docbook"/>
    <get src="https://freefr.dl.sourceforge.net/project/docbook/docbook-xsl/1.79.1/docbook-xsl-1.79.1.tar.bz2"
         dest="docbook/" usetimestamp="true"/>
    <bunzip2 src="docbook/docbook-xsl-1.79.1.tar.bz2"/>
    <untar src="docbook/docbook-xsl-1.79.1.tar" dest="docbook"
           overwrite="no"/>
    <process name="docbook" includes="docbook-xsl-1.79.1/*/*.xsl,docbook-xsl-1.79.1/*.xsl"
             arg="--xslt" license="docbook-xsl-1.79.1/COPYING"/>
  </target>
  
  <!-- HTMLBook -->
  <target name="htmlbook">
    <benchmark name="htmlbook"
      src="https://github.com/oreillymedia/HTMLBook/archive/master.zip"
      includes="HTMLBook-master/htmlbook-xsl/*.xsl" arg="--xslt"
      license="HTMLBook-master/LICENSE"/>
  </target>

  <!-- TEI XSL -->
  <target name="tei">
    <benchmark name="teixsl"
               src="https://github.com/TEIC/Stylesheets/archive/dev.zip"
               includes="Stylesheets-dev/*/*.xsl" arg="--xslt"
               license="Stylesheets-dev/LICENCE"/>
  </target>

  <target name="xquerydoc">
    <benchmark name="xquerydoc"
               src="https://github.com/xquery/xquerydoc/archive/master.zip"
               includes="xquerydoc-master/src/xquery/*.xq,xquerydoc-master/src/tests/unit/marklogic/*.xqy,xquerydoc-master/src/tests/examples/*.xqy" 
               arg="--xquery ../xslt/xqx2xql.xsl"
               license="xquerydoc-master/LICENCE"/>
  </target>

  <!-- only 51 extracted queries? -->
  <target name="guidomatic">
    <benchmark name="guidomatic"
               src="https://github.com/baskaufs/guid-o-matic/archive/master.zip"
               includes="guid-o-matic-master/*.xq,guid-o-matic-master/*.xqm" 
               arg="--xquery ../xslt/xqx2xql.xsl"
               license="guid-o-matic-master/LICENSE"/>
  </target>

  <!-- no open source license -->
  <target name="xquerrail">
    <benchmark name="xquerrail"
               src="https://github.com/garyvidal/xquerrail/archive/master.zip"
               includes="xquerrail-master/bin/lib/xqdoc-display.xqy,xquerrail-master/src/application/controller/default-controller.xqy,xquerrail-master/src/application/controller/demo-controller.xqy,xquerrail-master/src/application/views/default/default.index.html.xqy,xquerrail-master/src/application/views/default/default.login.html.xqy,xquerrail-master/src/application/views/demo/demo.accordion.html.xqy,xquerrail-master/src/application/views/demo/demo.portlet.html.xqy,xquerrail-master/src/application/views/demo/demo.editinplace.html.xqy,xquerrail-master/src/application/views/demo/demo.page-left-sidebar.html.xqy,xquerrail-master/src/application/views/demo/demo.form.html.xqy,xquerrail-master/src/application/views/demo/demo.forms.html.xqy,xquerrail-master/src/application/views/demo/demo.tinymce.html.xqy,xquerrail-master/src/application/views/demo/demo.dialog.html.xqy,xquerrail-master/src/application/views/demo/demo.msg.html.xqy,xquerrail-master/src/application/views/demo/demo.icons.html.xqy,xquerrail-master/src/application/views/demo/demo.two-column-layout.html.xqy,xquerrail-master/src/application/views/demo/demo.search.html.xqy,xquerrail-master/src/application/views/demo/demo.slider.html.xqy,xquerrail-master/src/application/views/demo/demo.flexigrid.html.xqy,xquerrail-master/src/application/views/demo/demo.three-column-layout.html.xqy,xquerrail-master/src/application/views/demo/demo.gallery.html.xqy,xquerrail-master/src/application/views/demo/demo.charts.html.xqy,xquerrail-master/src/application/views/demo/demo.validate.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.visualizations.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.navigation.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.controls.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.grids.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.index.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.containers.html.xqy,xquerrail-master/src/application/views/wijmo/wijmo.javascript.html.xqy,xquerrail-master/src/application/views/article/article.index.html.xqy,xquerrail-master/src/application/tags/pagination-tag.xqy,xquerrail-master/src/application/tags/echo-tag.xqy,xquerrail-master/src/application/tags/linkto-tag.xqy,xquerrail-master/src/application/tags/eval-tag.xqy,xquerrail-master/src/application/tags/breadcrumb-tag.xqy,xquerrail-master/src/application/tags/widget-x-tag.xqy,xquerrail-master/src/application/templates/footer.html.xqy,xquerrail-master/src/application/templates/header.html.xqy,xquerrail-master/src/application/templates/index.html.xqy,xquerrail-master/src/application/templates/fields.html.xqy,xquerrail-master/src/application/templates/two-columns.html.xqy,xquerrail-master/src/application/templates/head.html.xqy,xquerrail-master/src/application/templates/sidebar.html.xqy,xquerrail-master/src/application/templates/wijmo-theme.html.xqy,xquerrail-master/src/application/templates/top_buttons.html.xqy,xquerrail-master/src/application/templates/wijmo-main.html.xqy,xquerrail-master/src/application/templates/navigation.html.xqy,xquerrail-master/src/application/templates/main.html.xqy,xquerrail-master/src/application/templates/subnavigation.html.xqy,xquerrail-master/src/application/templates/toolbar.html.xqy,xquerrail-master/src/application/templates/login.html.xqy,xquerrail-master/src/testsuites/app/controller-tests.xqy,xquerrail-master/src/testsuites/framework/interceptor-tests.xqy,xquerrail-master/src/testsuites/framework/routing-tests.xqy,xquerrail-master/src/testsuites/framework/model-tests.xqy,xquerrail-master/src/testsuites/framework/config-tests.xqy,xquerrail-master/src/testsuites/framework/request-tests.xqy,xquerrail-master/src/testsuites/framework/base/model-tests.xqy,xquerrail-master/src/testsuites/framework/domain-tests.xqy,xquerrail-master/src/plugins/backbone/controller/default-controller.xqy,xquerrail-master/src/plugins/backbone/plugin.xqy,xquerrail-master/src/plugins/wijmo/controller/default-controller.xqy,xquerrail-master/src/plugins/wijmo/plugin.xqy,xquerrail-master/src/plugins/wijmo/lib/wijmo-lib.xqy,xquerrail-master/src/_framework/builders/controller-builder.xqy,xquerrail-master/src/_framework/dispatchers/dispatcher.web.xqy,xquerrail-master/src/_framework/dispatchers/dispatcher.xcc.xqy,xquerrail-master/src/_framework/interceptors/interceptor.ml-security.xqy,xquerrail-master/src/_framework/interceptors/interceptor.base.xqy,xquerrail-master/src/_framework/interceptors/interceptor.mocks.xqy,xquerrail-master/src/_framework/interceptors/interceptor.logging.xqy,xquerrail-master/src/_framework/interceptors/interceptor.profiler.xqy,xquerrail-master/src/_framework/rewriter.xqy,xquerrail-master/src/_framework/interceptor.xqy,xquerrail-master/src/_framework/config.xqy,xquerrail-master/src/_framework/helpers/wijmo.xqy,xquerrail-master/src/_framework/helpers/formbuilder-lists.xqy,xquerrail-master/src/_framework/helpers/form-builder.xqy,xquerrail-master/src/_framework/helpers/wijmo-lib.xqy,xquerrail-master/src/_framework/helpers/javascript.xqy,xquerrail-master/src/_framework/helpers/wijmo-builder.xqy,xquerrail-master/src/_framework/helpers/jquery.xqy,xquerrail-master/src/_framework/base/base-controller.xqy,xquerrail-master/src/_framework/base/views/base.error.html.xqy,xquerrail-master/src/_framework/base/views/base.remove.html.xqy,xquerrail-master/src/_framework/base/views/base.export.html.xqy,xquerrail-master/src/_framework/base/views/base.import.html.xqy,xquerrail-master/src/_framework/base/views/base.error.json.xqy,xquerrail-master/src/_framework/base/views/base.fields.html.xqy,xquerrail-master/src/_framework/base/views/base.save.html.xqy,xquerrail-master/src/_framework/base/views/base.find.html.xqy,xquerrail-master/src/_framework/base/views/base.edit.html.xqy,xquerrail-master/src/_framework/base/views/base.index.html.xqy,xquerrail-master/src/_framework/base/views/base.info.html.xqy,xquerrail-master/src/_framework/base/views/base.show.html.xqy,xquerrail-master/src/_framework/base/views/base.new.html.xqy,xquerrail-master/src/_framework/base/base-model.xqy,xquerrail-master/src/_framework/base/templates/footer.html.xqy,xquerrail-master/src/_framework/base/templates/header.html.xqy,xquerrail-master/src/_framework/base/templates/index.html.xqy,xquerrail-master/src/_framework/base/templates/head.html.xqy,xquerrail-master/src/_framework/base/templates/sidebar.html.xqy,xquerrail-master/src/_framework/base/templates/navigation.html.xqy,xquerrail-master/src/_framework/base/templates/main.html.xqy,xquerrail-master/src/_framework/base/templates/subnavigation.html.xqy,xquerrail-master/src/_framework/base/templates/login.html.xqy,xquerrail-master/src/_framework/engines/engine.json.xqy,xquerrail-master/src/_framework/engines/engine.html.xqy,xquerrail-master/src/_framework/engines/engine.xml.xqy,xquerrail-master/src/_framework/engines/engine.base.xqy,xquerrail-master/src/_framework/routing.xqy,xquerrail-master/src/_framework/response.xqy,xquerrail-master/src/_framework/model.xqy,xquerrail-master/src/_framework/request.xqy,xquerrail-master/src/_framework/domain.xqy,xquerrail-master/src/_framework/lib/mljson.xqy,xquerrail-master/src/_framework/lib/json.xqy,xquerrail-master/src/_framework/lib/reflection.xqy,xquerrail-master/src/_framework/lib/xray/index.xqy,xquerrail-master/src/_framework/lib/xray/src/xray.xqy,xquerrail-master/src/_framework/lib/xray/src/assertions.xqy,xquerrail-master/src/_framework/lib/xray/src/utils.xqy,xquerrail-master/src/_framework/lib/cprof/cprof.xqy,xquerrail-master/src/_framework/transpilers/parsers/CSS3Selectors.xqy,xquerrail-master/src/_framework/transpilers/parsers/relaxng-compact.xqy,xquerrail-master/src/_framework/transpilers/asts/CSS3Selectors-ast.xqy,xquerrail-master/src/_framework/transpilers/asts/relaxng-compact-ast.xqy,xquerrail-master/src/_framework/error.xqy,xquerrail-master/sandbox/wijmo.xqy,xquerrail-master/sandbox/wijmo-lib.xqy,xquerrail-master/sandbox/wijmo-builder.xqy,xquerrail-master/sandbox/jquery.xqy" 
               arg="--xquery ../xslt/xqx2xql.xsl"/>
  </target>

  <target name="marklogic">
    <benchmark name="marklogic"
               src="https://github.com/marklogic/commons/archive/master.zip"
               includes="commons-master/*/*.xqy" 
               arg="--xquery ../xslt/xqx2xql.xsl"/>
  </target>

  <target name="xqjson">
    <benchmark name="xqjson"
               src="https://github.com/joewiz/xqjson/archive/master.zip"
               includes="xqjson-master/src/content/*.xql"
               arg="--xquery ../xslt/xqx2xql.xsl" license="xqjson-master/LICENSE.txt"/>
  </target>

  <target name="histei">
    <benchmark name="histei"
               src="https://github.com/odaata/HisTEI/archive/master.zip"
               includes="HisTEI-master/frameworks/HisTEI/resources/*.xq*"
               arg="--xquery ../xslt/xqx2xql.xsl"
               license="HisTEI-master/LICENSE"/>
  </target>

  <!-- part of eXist-db -->
  <target name="xprocxq">
    <benchmark name="xprocxq"
               src="https://storage.googleapis.com/google-code-archive-source/v2/code.google.com/xprocxq/source-archive.zip"
               includes="xprocxq/trunk/main/*/xquery/*.xq*"
               arg="--xquery ../xslt/xqx2xql.xsl"
               license="xprocxq/trunk/main/LICENSE"/>
  </target>

  <target name="basex">
      <mkdir dir="basex"/>
      <get src="http://files.basex.org/releases/8.5.3/BaseX853.zip"
           dest="basex/source.zip" usetimestamp="true"/>
      <unzip src="basex/source.zip" dest="basex" overwrite="no"/>
      <unzip src="basex/basex/etc/modules.zip"
             dest="basex/basex/etc/modules/src/"/>
      <process name="basex" includes="basex/*/*/*/*.xq*" 
               arg="--xquery ../xqx2xql.xsl"
               license="basex/LICENSE"/>    
  </target>

  <target name="existdb">
    <benchmark name="existdb"
               src="https://codeload.github.com/eXist-db/exist/zip/develop"
               includes="exist-develop/test/src/xquery/*.xql,exist-develop/test/src/xquery/xquery3/*.xql,exist-develop/webapp/xqts/*.xql,exist-develop/webapp/*.xql,exist-develop/src/org/exist/*/*/*.xq*,exist-develop/extensions/indexes/lucene/test/src/xquery/lucene/*.xql,exist-develop/extensions/indexes/range/test/src/xquery/*.xql,exist-develop/extensions/modules/src/org/exist/xquery/modules/*/*.xq*,exist-develop/extensions/xprocxq/main/src/*/*.xq*"
               arg="--xquery ../xslt/xqx2xql.xsl"
               license="exist-develop/LICENSE"/>
  </target>
  
  <!-- download saxon if needed -->
  <target name="saxon">
    <local name="offline"/>
    <available file="../lib/saxon9he.jar" property="offline"/>
    <mkdir unless:set="offline" dir="../lib"/>
    <get unless:set="offline"
         src="https://downloads.sourceforge.net/project/saxon/Saxon-HE/9.7/SaxonHE9-7-0-14J.zip?r=https%3A%2F%2Fsourceforge.net%2Fprojects%2Fsaxon%2Ffiles%2FSaxon-HE%2F9.7%2F&amp;ts=1485885576&amp;use_mirror=vorboss"
         dest="../lib" usetimestamp="true"/>
    <unzip unless:set="offline" src="../lib/SaxonHE9-7-0-14J.zip" dest="../lib"
           overwrite="no"/>
  </target>
</project>
